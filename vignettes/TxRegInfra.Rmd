---
title: "TxRegInfra: support for TxRegQuery"
author: "Vincent J. Carey, stvjc at channing.harvard.edu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{TxRegInfra -- classes and methods for TxRegQuery}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::pdf_document:
    toc: yes 
    number_sections: yes 
  BiocStyle::html_document:
    highlight: pygments
    number_sections: yes 
    theme: united
    toc: yes 
---

```{r setup,echo=FALSE,results="hide"}
suppressPackageStartupMessages({
library(TxRegInfra)
library(GenomicFiles)
library(RMongo)
})
```

# Introduction

TxRegQuery addresses exploration of transcriptional regulatory networks
by integrating data on eQTL, digital genomic footprinting (DGF), DnaseI
hypersensitivity binding data (DHS), and transcription
factor binding site (TFBS) data.  Owing to the volume of emerging tissue-specific
data, special data modalities are used.

# Managing bed file content with mongodb

## Importing documents

Given a working MongoDb distribution with the command line
utility `mongoimport`, the following function can be used
to import a document formatted with tab-separated values.
This should be made more general.

```
> TxRegInfra:::.importToMongo
function (path, collectionName, fields, dbname = "db", type = "tsv", 
    importCmd = "mongoimport", host = "127.0.0.1") 
{
    if (type != "tsv") 
        stop("only handling tsv at this time")
    cmd = paste0(importCmd, " --host ", host, " --db ", dbname, 
        " --collection ", collectionName, " --type ", type, " --fields ", 
        fields, "  --file ", path)
    chk = try(system(cmd, intern = TRUE))
    if (inherits(chk, "try-error")) 
        return(chk)
    TRUE
}
```

## Querying the `txregnet` database

We have a long-running server that will respond to queries.
We focus on `r CRANpkg("mongolite")` as the interface.

### The connection 

```{r lkmong}
suppressPackageStartupMessages({
library(TxRegInfra)
library(mongolite)
})
con1 = mongo(url=URL_txregInAWS(), db="txregnet")
con1
```
We will write methods that work with the 'fields' of this object.

There is not much explicit reflectance in the mongolite API.
The following is improvised and may be fragile:
```{r lkpar}
parent.env(con1)$orig
```

We can get a list of collections in the database:
```{r getl}
head(c1 <- listAllCollections(url=URL_txregInAWS(), db="txregnet"))
```

We can get a record from a given collection:
```{r getl2}
mongo(url=URL_txregInAWS(), db="txregnet", collection=c1[1])
```

# An integrative container

We need to bind the metadata and information about the mongodb.

## Sample metadata

The following turns a very ad hoc filtering of the collection names
into a DataFrame.

```{r getcold}
cd = makeColData()
head(cd,2)
```

## Extended RaggedExperiment

```{r domor1}
rme0 = RaggedMongoExpt(con1, colData=cd)
rme1 = rme0[, which(cd$type=="FP")]
```

A key method in development is subsetting the archive by genomic coordinates.

```{r lksb}
s1 = sbov(rme1, GRanges("chr17", IRanges(38e6,38.4e6)))
s1
dim(ca <- compactAssay(s1, 3))
head(ca[,c(7,18)])
```

# Visualizing coincidence




